<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>내 주변 | 여기컬쳐</title>
</head>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
            var errorMessage = [[${errorMessage}]];
            if(errorMessage != null){
                alert(errorMessage);
            }

            var placeTab = $('.inner #placeTab');
            placeTab.css('font-weight', '700');
            placeTab.css('border-bottom', '2px solid black');

            if($('.addrField').text() == '주소 검색') {
                basicMap();
            } else {
                addrMap();
            }

        });

        // 주소 입력 전
        function basicMap() {
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(33.450701, 126.570667),
                level: 3 //지도의 레벨(확대, 축소 정도)
            };

            var map = new kakao.maps.Map(container, options);
        }

        // 주소 입력 후 마커 생성
        function addrMap() {
            var places = []; // 배열
            $('.placeCard').each(function(i) { // 박물관5, 미술관5 만큼 반복
                var place = $(this);

                var placeId = place.find('input[name=placeId]').val();
                var x = place.find('#geox-' +placeId).val();
                var y = place.find('#geoy-' +placeId).val();
                var name = place.find('#name-' +placeId).text();

                var placeInfo = {
                    x: x,
                    y: y,
                    name: name
                };

                places.push(placeInfo); // 위 정보 순서대로 배열에 넣기
            });

            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(places[0].x, places[0].y),
                level: 6
            };

            var map = new kakao.maps.Map(container, options);

            var positions = [ // 배열 places 사용해서 마커 생성
                {
                    title: places[0].name,
                    latlng: new kakao.maps.LatLng(places[0].x, places[0].y)
                },
                {
                    title: places[1].name,
                    latlng: new kakao.maps.LatLng(places[1].x, places[1].y)
                },
                {
                    title: places[2].name,
                    latlng: new kakao.maps.LatLng(places[2].x, places[2].y)
                },
                {
                    title: places[3].name,
                    latlng: new kakao.maps.LatLng(places[3].x, places[3].y)
                },
                {
                    title: places[4].name,
                    latlng: new kakao.maps.LatLng(places[4].x, places[4].y)
                },
                {
                    title: places[5].name,
                    latlng: new kakao.maps.LatLng(places[5].x, places[5].y)
                },
                {
                    title: places[6].name,
                    latlng: new kakao.maps.LatLng(places[6].x, places[6].y)
                },
                {
                    title: places[7].name,
                    latlng: new kakao.maps.LatLng(places[7].x, places[7].y)
                },
                {
                    title: places[8].name,
                    latlng: new kakao.maps.LatLng(places[8].x, places[8].y)
                },
                {
                    title: places[9].name,
                    latlng: new kakao.maps.LatLng(places[9].x, places[9].y)
                }
            ];

            for(var i=0; i < positions.length; i++) {
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: positions[i].latlng,
                    title: positions[i].title,
                });
            }
        }

        // 찜 추가
        function addLike(placeId) {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/place/like";
            var paramData = {
                itemId : placeId
            }

            var param = JSON.stringify(paramData);

            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data : param,
                beforeSend : function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                dataType : "json",
                cache : false,
                success : function(result, status){
                    var itemId = result;
                    var button = $(`button.likeBtn[value='${itemId}']`);
                    if(button.css('color') === 'rgb(255, 0, 0)') {
                        button.css('color', 'grey');
                    } else {
                        button.css('color', 'red');
                    }
                },
                error : function(jqXHR, status, error){
                    alert('찜 기능은 로그인 후 이용 가능합니다.');
                    location.href = '/members/login';
                }
            });
        }
    </script>
</th:block>

<div layout:fragment="content">
    <div class="container" id="placeMain">
        <!-- 주소검색 버튼 -->
        <button type="button" class="searchAddr" onclick="location.href='/place/address'">
            <span class="material-symbols-outlined">my_location</span>
            <span th:if="${simAddr} == null" class="addrField">주소 검색</span>
            <span th:unless="${simAddr} == null" th:text="${simAddr}" class="addrField"></span>
            <span class="material-symbols-outlined">keyboard_arrow_down</span>
        </button>

        <!-- 카카오 맵 -->
        <section class="placeMainMap">
            <div class="desc"><span class="material-symbols-outlined">map</span> 내 주변 박물관/미술관</div>
            <div id="map"></div>
        </section>

        <section class="placeList">
            <div class="placeWrap">
                <div class="placeTitle">
                    <h2>내주변 박물관</h2>
                </div>
                <span class="more">
                    <a th:if="${simAddr} == null" href="/place/list/museum">더보기</a>
                    <a th:unless="${simAddr} == null" th:href="'/place/list/museum/' + ${simAddr}">더보기</a>
                </span>
                <div class="prdPlace">
                    <!-- 내주변 박물관 목록 (5) -->
                    <th:block th:each="museum : ${museums}">
                        <div class="card placeCard">
                            <input type="hidden" th:value="${museum.id}" name="placeId">
                            <input type="hidden" th:value="${museum.geoX}" th:id="'geox-' +${museum.id}">
                            <input type="hidden" th:value="${museum.geoY}" th:id="'geoy-' +${museum.id}">
                            <h5 class="card-header">
                                <!-- userLikeYn이 null이면 찜한 상품 아님 -->
                                <th:block th:if="${museum.userLikeYn == null}">
                                    <button type="button" th:value="${museum.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined">favorite</span>
                                    </button>
                                </th:block>
                                <!-- userLikeYn이 null이 아니면 찜한 상품, css 추가 -->
                                <th:block th:unless="${museum.userLikeYn == null}">
                                    <button type="button" th:value="${museum.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined" style="color: red">favorite</span>
                                    </button>
                                </th:block>
                                <div th:text="${museum.name}" class="placeName" th:id="'name-' +${museum.id}"></div>
                            </h5>
                            <div class="card-body">
                                <h5 th:text="${museum.address}" class="card-title placeAddr"></h5>
                                <p th:text="${museum.openTime +' ~ '+ museum.closeTime}" class="card-text placeTime"></p>
                                <a th:href="'/place/detail/' + ${museum.id}" class="btn btn-outline-secondary btn-sm">자세히 보기</a>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="placeWrap">
                <div class="placeTitle">
                    <h2>내주변 미술관</h2>
                </div>
                <span class="more">
                    <a th:if="${simAddr} == null" href="/place/list/art">더보기</a>
                    <a th:unless="${simAddr} == null" th:href="'/place/list/art/' + ${simAddr}">더보기</a>
                </span>
                <div class="prdPlace">
                    <!-- 내주변 미술관 목록 (5) -->
                    <th:block th:each="art : ${arts}">
                        <div class="card placeCard">
                            <input type="hidden" th:value="${art.id}" name="placeId">
                            <input type="hidden" th:value="${art.geoX}" th:id="'geox-' +${art.id}">
                            <input type="hidden" th:value="${art.geoY}" th:id="'geoy-' +${art.id}">
                            <h5 class="card-header">
                                <th:block th:if="${art.userLikeYn == null}">
                                    <button type="button" th:value="${art.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined">favorite</span>
                                    </button>
                                </th:block>
                                <th:block th:unless="${art.userLikeYn == null}">
                                    <button type="button" th:value="${art.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined" style="color: red">favorite</span>
                                    </button>
                                </th:block>
                                <div th:text="${art.name}" class="placeName" th:id="'name-' +${art.id}"></div>
                            </h5>
                            <div class="card-body">
                                <h5 th:text="${art.address}" class="card-title placeAddr"></h5>
                                <p th:text="${art.openTime +' ~ '+ art.closeTime}" class="card-text placeTime"></p>
                                <a th:href="'/place/detail/' + ${art.id}" class="btn btn-outline-secondary btn-sm">자세히 보기</a>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="placeWrap">
                <div class="placeTitle">
                    <h2>내주변 축제</h2>
                </div>
                <span class="more"><a>더보기</a></span>
                <div class="prdPlace">
                    <!-- 내주변 축제/행사 목록 (5) -->
                    <th:block th:each="festival : ${festivals}">
                        <div class="item">
                            <a th:href="'/item/' + ${festival.id}">
                                <div class="placeImgWrap">
                                    <img th:src="${festival.imgUrl}" th:alt="${festival.itemName}">
                                </div>
                                <div class="detail">
                                    <span th:text="${festival.itemName}" class="detail_title" style="font-size: 15px"></span>
                                    <span th:text="${festival.address}" class="detail_place" style="font-size: 14px"></span>
                                    <span th:text="${festival.startDay +' ~ '+ festival.endDay}" class="detail_date" style="font-size: 14px"></span>
                                </div>
                            </a>
                        </div>
                    </th:block>
                </div>
            </div>
        </section>
    </div>
</div>
</html>