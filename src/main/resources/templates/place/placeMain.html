<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<th:block layout:fragment="css">
    <style>
        .searchAddr {
            border: none;
            background: none;
            font-size: 20px;
            font-weight: 700;
        }
        .placeMenu {
            width: 60%;
            display: flex;
            padding: 0 30px;
            gap: 33%;
            margin: 80px auto;
        }
        .placeMenu button {
            flex-wrap: wrap;
            background: none;
            border: none;
        }
        .placeIcon {
            position: relative;
        }
        .placeIcon span {
            font-size: 70px;
        }
        .placeText {
            color: #000;
            width: 100%;
            line-height: 1.4;
            padding-top: 2px;
        }
        .placeWrap {
            position: relative;
            margin-top: 100px;
        }
        .placeWrap .more {
            top: 20px;
            right: 12px;
            position: absolute;
        }
        .placeWrap span a {
            color: #8D8D8D;
            display: inline-flex;
            align-items: center;
            text-decoration: none;
        }
        .placeTitle h2 {
            font-size: 20px;
            font-weight: 700;
        }
        .prdPlace {
            display: flex;
            flex-direction: row;
            margin-top: 30px;
            width: 100%;
        }

        .likeBtn {
            background: none;
            border: none;
            float: right;
            color: #808080;
        }

        .prdPlace .item {
            margin-right: 7px;
            width: 20%;
        }
        .placeImgWrap img {
            width: 230px;
            height: 150px;
            border-radius: 8px;
        }
        .prdPlace .detail {
            display: flex;
            padding: 0 4px;
            flex-direction: column;
            align-items: flex-start;
            align-self: stretch;
            height: 100px;
            width: 230px;
            text-align: left;
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
            var errorMessage = [[${errorMessage}]];
            if(errorMessage != null){
                alert(errorMessage);
            }

            basicMap();

            console.log(places[1]);
            console.log(places[9]);

        });

        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                    // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                    // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                    var addr = ''; // 주소 변수
                    var extraAddr = ''; // 참고항목 변수

                    //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                    if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                        addr = data.sigungu;
                    } else { // 사용자가 지번 주소를 선택했을 경우(J)
                        addr = data.sigungu;
                    }

                    $("#address").val(addr);

                    // 주소 필드의 입력이 변경될 때마다 콘솔에 출력
                    $("#address").off('input').on('input', function() {
                        console.log("Address changed:", $(this).val());
                    });

                    // 콘솔에 설정된 주소 값 출력 (디버깅용)
                    console.log("Address set:", addr);
                }
            }).open();
        }

        function basicMap() {
            var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
            var options = { //지도를 생성할 때 필요한 기본 옵션
                center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
                level: 3 //지도의 레벨(확대, 축소 정도)
            };

            var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
        }

        function addrMap() {
            var places = [];
            $('.placeBox').each(function(i) {
                var place = $(this);

                var placeId = place.find('input[name=placeId]').val();
                var x = place.find('#geox-' +placeId).val();
                var y = place.find('#geoy-' +placeId).val();
                var name = place.find('#name-' +placeId).text();

                var placeInfo = {
                    x: x,
                    y: y,
                    name: name
                };

                places.push(placeInfo);
            });

            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(37.402707, 126.922044),
                level: 4
            };

            var map = new kakao.maps.Map(container, options);
        }

        function addLike(placeId) {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/place/like";
            var paramData = {
                itemId : placeId
            }

            var param = JSON.stringify(paramData);

            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data : param,
                beforeSend : function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                dataType : "json",
                cache : false,
                success : function(result, status){
                    alert('찜추가 성공');
                },
                error : function(jqXHR, status, error){
                    alert('찜 기능은 로그인 후 이용 가능합니다.');
                    location.href = '/members/login';
                }
            });
        }


    </script>
</th:block>

<div layout:fragment="content">
    <div class="container">
        <button type="button" class="searchAddr" onclick="location.href='/place/address'">
            <span th:if="${simAddr} == null">주소 찾기</span>
            <span th:unless="${simAddr} == null" th:text="${simAddr}"></span>
            <span class="material-symbols-outlined">keyboard_arrow_down</span>
        </button>

        <section class="placeMainMap">
            <div id="map" style="width:500px;height:400px;"></div>
        </section>

        <section class="placeList">
            <div class="placeWrap">
                <div class="placeTitle">
                    <h2>내주변 박물관</h2>
                </div>
                <span class="more"><a th:href="'/place/list/museum/' + ${simAddr}">더보기</a></span>
                <div class="prdPlace">
                    <th:block th:each="museum : ${museums}">
                        <div class="placeBox">
                            <input type="hidden" th:value="${museum.id}" name="placeId">
                            <input type="hidden" th:value="${museum.geoX}" th:id="'geox-' +${museum.id}">
                            <input type="hidden" th:value="${museum.geoY}" th:id="'geoy-' +${museum.id}">
                            <a th:href="'/place/detail/' + ${museum.id}">
                                <th:block th:if="${museum.userLikeYn == null}">
                                    <button type="button" th:value="${museum.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined">favorite</span>
                                    </button>
                                </th:block>
                                <th:block th:unless="${museum.userLikeYn == null}">
                                    <button type="button" th:value="${museum.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined" style="color: red">favorite</span>
                                    </button>
                                </th:block>
                                <div th:text="${museum.name}" class="placeName" th:id="'name-' +${museum.id}"></div>
                                <div th:text="${museum.address}" class="placeAddr"></div>
                                <div th:text="${museum.openTime +' ~ '+ museum.closeTime}" class="placeTime"></div>
                            </a>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="placeWrap">
                <div class="placeTitle">
                    <h2>내주변 미술관</h2>
                </div>
                <span class="more"><a th:href="'/place/list/art/' + ${simAddr}">더보기</a></span>
                <div class="prdPlace">
                    <th:block th:each="art : ${arts}">
                        <div class="placeBox">
                            <input type="hidden" th:value="${art.id}" name="placeId">
                            <input type="hidden" th:value="${art.geoX}" th:id="'geox-' +${art.id}">
                            <input type="hidden" th:value="${art.geoY}" th:id="'geoy-' +${art.id}">
                            <a th:href="'/place/detail/' + ${art.id}">
                                <th:block th:if="${art.userLikeYn == null}">
                                    <button type="button" th:value="${art.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined">favorite</span>
                                    </button>
                                </th:block>
                                <th:block th:unless="${art.userLikeYn == null}">
                                    <button type="button" th:value="${art.id}" onclick="addLike(this.value)" class="likeBtn">
                                        <span class="material-symbols-outlined" style="color: red">favorite</span>
                                    </button>
                                </th:block>
                                <div th:text="${art.name}" class="placeName" th:id="'name-' +${art.id}"></div>
                                <div th:text="${art.address}" class="placeAddr"></div>
                                <div th:text="${art.openTime +' ~ '+ art.closeTime}" class="placeTime"></div>
                            </a>
                        </div>
                    </th:block>
                </div>
            </div>
            <div class="placeWrap">
                <div class="placeTitle">
                    <h2>내주변 축제</h2>
                </div>
                <span class="more"><a>더보기</a></span>
                <div class="prdPlace">
                    <th:block th:each="festival : ${festivals}">
                        <div class="item">
                            <a th:href="'/item/' + ${festival.id}">
                                <div class="placeImgWrap">
                                    <img th:src="${festival.imgUrl}" th:alt="${festival.itemName}">
                                </div>
                                <div class="detail">
                                    <span th:text="${festival.itemName}" class="detail_title" style="font-size: 15px"></span>
                                    <span th:text="${festival.address}" class="detail_place" style="font-size: 14px"></span>
                                    <span th:text="${festival.startDay +' ~ '+ festival.endDay}" class="detail_date" style="font-size: 14px"></span>
                                </div>
                            </a>
                        </div>
                    </th:block>
                </div>
            </div>
        </section>
    </div>
</div>
</html>