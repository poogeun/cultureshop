<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<th:block layout:fragment="css">
    <style>


    </style>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
            var errorMessage = [[${errorMessage}]];
            if(errorMessage != null){
                alert(errorMessage);
            }

            $('#reqWrite').hide();
            $('#delReq').change(function() {
                if($(this).val() === '직접 입력') {
                    $('#reqWrite').show();
                }
                else {
                    $('#reqWrite').hide();
                }
            });

            $('.delFree').show();
            $('.delCharge').hide();
            $('input[name="getTicket"]').change(function() {
                if($(this).val() === '현장수령') {
                    $('.delFree').show();
                    $('.delCharge').hide();
                }
                else {
                    $('.delCharge').show();
                    $('.delFree').hide();
                }
            });

           getPerPrice();

           $('.count').on('change', function() {
                getTotalPrice();
           });

        });

        function getPerPrice() {

            var totalPrice = 0;
            var delPayPrice = 0;

            $('.orderItemDtl').each(function() {
                var item = $(this);
                var price = parseInt(item.find('.price').text().replace('원', '').trim());

                totalPrice += price;
                delPayPrice = totalPrice + 3000;
                $('#totalPrice').html(totalPrice + '원');
                $('#delFree').html(totalPrice + '원');
                $('#delCharge').html(delPayPrice + '원');


                item.find('.count').on('change', function(e) {
                    if($(this).is(e.currentTarget)) {
                        var perCount = $(this).val();
                        var perPrice = perCount * price;
                        item.find('.price').html(perPrice + '원');
                    }
                });
            });
        }

        function getTotalPrice() {

            var totalPrice = 0;
            var delPayPrice = 0;

            $('.orderItemDtl').each(function() {
                var item = $(this);
                var price = parseInt(item.find('.price').text().replace('원', '').trim());

                totalPrice += price;
                delPayPrice = totalPrice + 3000;
                $('#totalPrice').html(totalPrice + '원');
                $('#delFree').html(totalPrice + '원');
                $('#delCharge').html(delPayPrice + '원');
            });
        }

        function orders() {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/order/like";

            var dataList = new Array();
            var paramData = new Object();

            var orderPrice;
            if($('input[name="getTicket"]').val() === '현장수령'){
                orderPrice = parseInt($('#delFree').text());
            }
            else {
                orderPrice = parseInt($('#delCharge').text());
            }
            var address = $('#address').val();
            var delReq = $('#delReq').val();
            var reqWrite = $('#reqWrite').val();
            var getTicket = $('input[name=getTicket]:checked').val();

            $('.orderItemDtl').each(function() {
                var likeItemId = $(this).find('input[name=likeItemId]').val();
                var itemId = $(this).find('input[name=itemId]').val();
                var count = $(this).find('input[name=count]').val();
                var viewDay = $(this).find('input[name=date]').val();

                var data = {
                    likeItemId : likeItemId,
                    itemId : itemId,
                    count : count,
                    viewDay : viewDay,
                    orderPrice : orderPrice,
                    address : address,
                    delReq : delReq,
                    reqWrite : reqWrite,
                    getTicket : getTicket
                }
                dataList.push(data);
            });

            paramData['likeOrderFormDtoList'] = dataList;
            var param = JSON.stringify(paramData);

            console.log(param);
            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data : param,
                beforeSend : function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                dataType : "text",
                cache : false,
                success : function(result, status){
                    var orderUid = result;
                    requestPay(orderUid);
                },
                error : function(jqXHR, status, error) {
                    if(jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요.');
                    }
                    else {
                        alert(jqXHR.responseText);
                    }
                }
            });
        }

        var IMP = window.IMP;
        IMP.init("imp16131530");
        function requestPay(orderUid) {

            var itemName = $('ul li:first-child h3').text();

            console.log(orderUid);

            var paymentPrice;
            if($('input[name="getTicket"]').val() === '현장수령'){
                paymentPrice = parseInt($('#delFree').text().replace('원', '').trim());
            }
            else {
                paymentPrice = parseInt($('#delCharge').text().replace('원', '').trim());
            }
            console.log(paymentPrice);

            var buyerName = $('#orderName').val();
            var buyerEmail = $('#email').val();
            var buyerAddress = $('#address').val();
            var buyerTel = $('#orderTel').val();

            IMP.request_pay({
                pg : 'html5_inicis.INIpayTest',
                pay_method : 'card',
                merchant_uid: orderUid,
                name : itemName,
                amount : paymentPrice,
                buyer_email : buyerEmail,
                buyer_name : buyerName,
                buyer_tel : buyerTel,
                buyer_addr : buyerAddress,
                buyer_postcode : '123-456',
            },
            function(rsp) {

                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");

                if (rsp.success) {
                    alert('call back!! ' + JSON.stringify(rsp));

                    jQuery.ajax({
                        url: "/payment",
                        method: "POST",
                        beforeSend : function(xhr){
                            xhr.setRequestHeader(header, token);
                        },
                        headers: {"Content-Type": "application/json"},
                        data: JSON.stringify({
                            "payment_uid": rsp.imp_uid,      // 결제 고유번호
                            "order_uid": rsp.merchant_uid   // 주문번호
                        })
                    }).done(function (response) {
                        window.location.href = "/order/success"
                    })
                } else {
                    alert('결제 취소' + rsp);

                    jQuery.ajax({
                        url: "/order/" + rsp.merchant_uid,
                        method: "DELETE",
                        beforeSend : function(xhr){
                            xhr.setRequestHeader(header, token);
                        },
                        headers: {"Content-Type": "application/json"}
                    }).done(function(response) {
                        console.log("주문 삭제 응답: ", response);
                        alert('주문이 취소되었습니다.');
                        window.location.href = "/";
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('주문 삭제 중 오류 발생: ', textStatus, errorThrown);
                        console.error('HTTP 상태 코드: ', jqXHR.status);
                        console.error('응답 본문: ', jqXHR.responseText);
                        alert('주문 삭제 중 오류가 발생했습니다. 다시 시도해주세요.');
                    });
                }
            });
        }



    </script>
</th:block>

<div layout:fragment="content">
    <div class="container">
        <section class="orderInfo">
            <div class="subTitle">
                <div>배송정보</div>
            </div>
            <div class="subContents">
                <div class="oiContent">
                    <div class="memInfos">
                        <div class="col-sm-6">
                            <label for="orderName" class="form-label" style="color: #808080">받는 사람</label>
                            <input class="form-control" type="text" th:value="${member.name}" id="orderName" readonly>
                        </div>
                        <div class="col-sm-6">
                            <label for="orderTel" class="form-label" style="color: #808080">휴대전화</label>
                            <input class="form-control" type="text" th:value="${member.tel}" id="orderTel" readonly>
                        </div>
                        <div class="col-12">
                            <label for="address" class="form-label" style="color: #808080">주소</label>
                            <input type="text" class="form-control" th:value="${member.address}" id="address">
                        </div>
                    </div>
                    <div class="delReq">
                        <div class="col-md-6">
                            <label for="delReq" class="form-label" style="color: #808080">배송 요청사항</label>
                            <select class="form-select" id="delReq">
                                <option value="요청사항없음">배송 요청 사항을 선택하세요.</option>
                                <option value="배송 전 연락 바랍니다.">배송 전 연락 바랍니다.</option>
                                <option value="부재시 휴대전화로 연락주세요.">부재시 휴대전화로 연락주세요.</option>
                                <option value="부재시 경비실에 맡겨주세요.">부재시 경비실에 맡겨주세요.</option>
                                <option value="부재시 문앞에 놓아주세요.">부재시 문앞에 놓아주세요.</option>
                                <option value="직접 입력">직접 입력</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <textarea class="form-control" id="reqWrite" rows="3" placeholder="배송 요청 사항을 입력하세요.(최대 50자)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="getTicket">
            <div class="subTitle">
                <div>티켓 수령 방법</div>
            </div>
            <div class="subContents">
                <div class="gtContent">
                    <div class="form-check gtSelect">
                        <input class="form-check-input" type="radio" value="현장수령" name="getTicket" id="scene" checked>
                        <label class="form-check-label" for="scene">
                            현장수령
                        </label>
                    </div>
                    <div class="form-check gtSelect">
                        <input class="form-check-input" type="radio" value="배송" name="getTicket" id="delivery">
                        <label class="form-check-label" for="delivery">
                            배송 (3000원)
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <section class="orderItemInfo">
            <div class="subTitle">
                <div>상품 정보</div>
            </div>
            <div class="subContents">
                <div class="oiiContent">
                    <ul class="orderItems">
                        <th:block th:each="likeItem : ${likeItems}">
                            <li class="orderItemDtl">
                                <input type="hidden" th:value="${likeItem.likeItemId}" name="likeItemId">
                                <input type="hidden" th:value="${likeItem.itemId}" name="itemId">
                                <div class="oidWrap">
                                    <img th:src="${likeItem.imgUrl}" th:alt="${likeItem.itemName}">
                                    <div class="orderItemText">
                                        <div class="oit_1">
                                            <h3 th:text=${likeItem.itemName} style="font-weight: bold"></h3>
                                            <div class="row g-3 align-items-center">
                                                <div class="col-auto">
                                                    <label class="col-form-label">관람일</label>
                                                </div>
                                                <div class="col-auto">
                                                    <input type="date" name="date" th:min="${likeItem.startDay}"
                                                           th:max="${likeItem.endDay}" class="form-control">
                                                </div>
                                            </div>
                                            <div class="row g-3 align-items-center">
                                                <div class="col-auto">
                                                    <label class="col-form-label">수량</label>
                                                </div>
                                                <div class="col-auto">
                                                    <input type="number" class="count" name="count" value="1" min="1">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="oit_2">
                                            <strong th:text="${likeItem.price + '원'}" class="price" style="font-size: 20px"></strong>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </th:block>
                    </ul>
                </div>
            </div>
        </section>

        <section class="payment">
            <div class="subTitle">
                <div>결제금액</div>
            </div>
            <div class="subContents">
                <div class="pmContent">
                    <table class="table border-top">
                        <colgroup>
                            <col width="30%">
                            <col width="70%">
                        </colgroup>
                        <tr>
                            <th class="p-3 bg-body-tertiary">총 상품금액</th>
                            <td id="totalPrice"></td>
                        </tr>
                        <tr>
                            <th class="p-3 bg-body-tertiary">배송비</th>
                            <td class="delCharge">
                                +3,000원
                            </td>
                            <td class="delFree">
                                없음
                            </td>
                        </tr>
                        <tr>
                            <th class="p-3 bg-body-tertiary">총 결제금액</th>
                            <td class="delCharge" style="color: #C10000" id="delCharge"></td>
                            <td class="delFree" style="color: #C10000" id="delFree"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </section>


        <div class="d-grid gap-2 payBtn">
            <button class="btn btn-primary btn-lg" type="button" onclick="orders()">결제하기</button>
        </div>

    </div>
</div>
</html>