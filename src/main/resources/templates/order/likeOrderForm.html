<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<th:block layout:fragment="css">
    <style>


    </style>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
            var errorMessage = [[${errorMessage}]];
            if(errorMessage != null){
                alert(errorMessage);
            }

            $('#reqWrite').hide();
            $('#delReq').change(function() {
                if($(this).val() === '직접 입력') {
                    $('#reqWrite').show();
                }
                else {
                    $('#reqWrite').hide();
                }
            });

            $('.delFree').show();
            $('.delCharge').hide();
            $('input[name="getTicket"]').change(function() {
                if($(this).val() === '현장수령') {
                    $('.delFree').show();
                    $('.delCharge').hide();
                }
                else {
                    $('.delCharge').show();
                    $('.delFree').hide();
                }
            });

           getPerPrice();

           $('.count').on('change', function() {
                getTotalPrice();
           });

        });

        function getPerPrice() {

            var totalPrice = 0;
            $('.orderItemDtl').each(function() {
                var item = $(this);
                var price = parseInt(item.find('.price').text().replace('원', '').trim());

                totalPrice += price;
                $('#totalPrice').html(totalPrice + '원');

                item.find('.count').on('change', function(e) {
                    if($(this).is(e.currentTarget)) {
                        var perCount = $(this).val();
                        var perPrice = perCount * price;
                        item.find('.price').html(perPrice + '원');
                    }
                });
            });
        }

        function getTotalPrice() {

            var totalPrice = 0;
            $('.orderItemDtl').each(function() {
                var item = $(this);
                var price = parseInt(item.find('.price').text().replace('원', '').trim());

                totalPrice += price;
                $('#totalPrice').html(totalPrice + '원');
            });

        }



        function order() {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var url = "/order";
            var paramData = {
                itemId : $('#itemId').val(),
                count : $('#count').val(),
                viewDay : $('#date').val(),
                address: $('#address').val(),
                delReq: $('#delReq').val(),
                reqWrite: $('#reqWrite').val(),
                getTicket: $("input[name='getTicket']:checked").val()
            }

            var param = JSON.stringify(paramData);

            console.log("Sending request with data:", param);

            $.ajax({
                url : url,
                type : "POST",
                contentType : "application/json",
                data : param,
                beforeSend : function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                dataType : "json",
                cache : false,
                success : function(result, status) {
                    alert('주문이 완료 되었습니다.');
                },
                error : function(jqXHR, status, error) {
                    if(jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요.');
                    }
                    else {
                        alert(jqXHR.responseText);
                    }
                }
            });

        }




    </script>
</th:block>

<div layout:fragment="content">
    <div class="container">
        <section class="orderInfo">
            <div class="subTitle">
                <div>배송정보</div>
            </div>
            <div class="subContents">
                <div class="oiContent">
                    <div class="memInfos">
                        <div class="col-sm-6">
                            <label for="orderName" class="form-label" style="color: #808080">받는 사람</label>
                            <input class="form-control" type="text" th:value="${member.name}" id="orderName" readonly>
                        </div>
                        <div class="col-sm-6">
                            <label for="orderTel" class="form-label" style="color: #808080">휴대전화</label>
                            <input class="form-control" type="text" th:value="${member.tel}" id="orderTel" readonly>
                        </div>
                        <div class="col-12">
                            <label for="address" class="form-label" style="color: #808080">주소</label>
                            <input type="text" class="form-control" th:value="${member.address}" id="address">
                        </div>
                    </div>
                    <div class="delReq">
                        <div class="col-md-6">
                            <label for="delReq" class="form-label" style="color: #808080">배송 요청사항</label>
                            <select class="form-select" id="delReq">
                                <option value="요청사항없음">배송 요청 사항을 선택하세요.</option>
                                <option value="배송 전 연락 바랍니다.">배송 전 연락 바랍니다.</option>
                                <option value="부재시 휴대전화로 연락주세요.">부재시 휴대전화로 연락주세요.</option>
                                <option value="부재시 경비실에 맡겨주세요.">부재시 경비실에 맡겨주세요.</option>
                                <option value="부재시 문앞에 놓아주세요.">부재시 문앞에 놓아주세요.</option>
                                <option value="직접 입력">직접 입력</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <textarea class="form-control" id="reqWrite" rows="3" placeholder="배송 요청 사항을 입력하세요.(최대 50자)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="getTicket">
            <div class="subTitle">
                <div>티켓 수령 방법</div>
            </div>
            <div class="subContents">
                <div class="gtContent">
                    <div class="form-check gtSelect">
                        <input class="form-check-input" type="radio" value="현장수령" name="getTicket" id="scene" checked>
                        <label class="form-check-label" for="scene">
                            현장수령
                        </label>
                    </div>
                    <div class="form-check gtSelect">
                        <input class="form-check-input" type="radio" value="배송" name="getTicket" id="delivery">
                        <label class="form-check-label" for="delivery">
                            배송 (3000원)
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <section class="orderItemInfo">
            <div class="subTitle">
                <div>상품 정보</div>
            </div>
            <div class="subContents">
                <div class="oiiContent">
                    <ul class="orderItems">
                        <th:block th:each="likeItem : ${likeItems}">
                            <li class="orderItemDtl">
                                <div class="oidWrap">
                                    <img th:src="${likeItem.imgUrl}" th:alt="${likeItem.itemName}">
                                    <div class="orderItemText">
                                        <div class="oit_1">
                                            <h3 th:text=${likeItem.itemName} style="font-weight: bold"></h3>
                                            <div class="row g-3 align-items-center">
                                                <div class="col-auto">
                                                    <label for="date" class="col-form-label">관람일</label>
                                                </div>
                                                <div class="col-auto">
                                                    <input type="date" id="date" th:min="${likeItem.startDay}" th:max="${likeItem.endDay}" class="form-control">
                                                </div>
                                            </div>
                                            <div class="row g-3 align-items-center">
                                                <div class="col-auto">
                                                    <label for="count" class="col-form-label">수량</label>
                                                </div>
                                                <div class="col-auto">
                                                    <input type="number" class="count" name="count" id="count" value="1" min="1">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="oit_2">
                                            <strong th:text="${likeItem.price + '원'}" class="price" style="font-size: 20px"></strong>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </th:block>
                    </ul>
                </div>
            </div>
        </section>

        <section class="payment">
            <div class="subTitle">
                <div>결제금액</div>
            </div>
            <div class="subContents">
                <div class="pmContent">
                    <table class="table border-top">
                        <colgroup>
                            <col width="30%">
                            <col width="70%">
                        </colgroup>
                        <tr>
                            <th class="p-3 bg-body-tertiary">총 상품금액</th>
                            <td id="totalPrice"></td>
                        </tr>
                        <tr>
                            <th class="p-3 bg-body-tertiary">배송비</th>
                            <td class="delCharge">
                                +3,000원
                            </td>
                            <td class="delFree">
                                없음
                            </td>
                        </tr>
                        <tr>
                            <th class="p-3 bg-body-tertiary">총 결제금액</th>
                            <!--
                            <td th:text="${item.price * count + 3000} + '원'" class="delCharge" style="color: #C10000"></td>
                            <td th:text="${item.price * count} + '원'" class="delFree" style="color: #C10000"></td>
                            -->
                        </tr>
                    </table>
                </div>
            </div>
        </section>


        <div class="d-grid gap-2 payBtn">
            <button class="btn btn-primary btn-lg" type="button" onclick="order()">결제하기</button>
        </div>

    </div>
</div>
</html>